library(tidyverse)
library(raster)
library(foreign)
library(rgdal)
library(spdplyr)
library(stringr)
library(rgeos)
library(broom)
library(maptools)


path_data <- 'D:/CIAT/USAID/Soils/data/'

## Textura informacion CIAT
raster_textura <- raster(paste0(path_data, 'Soil_Colombia/Clasificación textural/Clasificacion textural.tif'))  ## Clasificación de texturas
class_textura <- read.dbf(paste0(path_data, 'Soil_Colombia/Clasificación textural/Clasificacion textural.tif.vat.dbf'))


class_textura <- class_textura %>%
  mutate(ClaseNum = 1:length(ClaseText))

## Shape Colombia SIGOT
shape_colombia <- readOGR(dsn = paste0(path_data, 'Shape_Colombia/Municipios_SIGOT_geo.shp'),
                          layer = 'Municipios_SIGOT_geo')

# shape_colombia_fortify <- fortify(shape_colombia)
## Cambiando la codificacion de las columnas necesarias

shape_colombia <- shape_colombia %>%
  mutate(NOM_MUNICI = iconv(NOM_MUNICI, 'UTF-8', 'latin1'), 
         NOMBRE_DPT = iconv(NOMBRE_DPT, 'UTF-8', 'latin1'))


## Rasta information (was generated by AEPS (Big Data CIAT))

rasta <- read_csv(paste0(path_data, 'Soil_Rasta/Rastas_3.csv')) %>%
  mutate(ID_LOTE = as.character(ID_LOTE))

## Management Cordoba

management_cordoba <- read_csv(paste0(path_data, 'Soil_Rasta/Practicas_Cordoba.csv'))

## sacar textura para Cordoba (merge entre rasta y el archivo de Practicas cordoba by ID_LOTE)

vars_ID <- management_cordoba %>%
  dplyr::select(ID_LOTE, MUNICIPIO, DEPARTAMENTO) 

soil_rasta_df <- inner_join(rasta, vars_ID, by = 'ID_LOTE')



## Departamentos a utilizar: Tolima, Cordoba, Valle, Casanare
# es importante poder mostrar en que lados de Colombia tenemos informacion acerca de la informacion de Rasta

zonas <- paste('TOLIMA', 'CÓRDOBA', 'VALLE', 'CASANARE', sep = '|')

soils_dpto <- shape_colombia %>%
  filter(str_detect(NOMBRE_DPT, zonas))

# soils_dpto %>%
#   dplyr::select(NOMBRE_DPT) %>%
#   group_by(NOMBRE_DPT) %>%
#   summarise(n())
# tidy(soils_dpto, region = "NOMBRE_DPT")

extent_region <- soils_dpto %>%
  extent()


text_dptos <- crop(raster_textura, extent_region)

# plot(text_dptos)
# plot(soils_dpto, add = T)

## plotear las 5 texturas mas representativas por departamento y por muninicipio
# tolima <- filter(soils_dpto, NOMBRE_DPT == 'TOLIMA')
# text_tolima <- crop(text_dptos, tolima)

# tolima_df <- filter(soils_dpto, NOMBRE_DPT == 'TOLIMA') %>%
#   .@data %>%
#   tbl_df()

# extract(text_tolima, tolima)  funciona

extract_by_polygon <- function(i, r, shape){
  
  # r <- text_tolima
  # shape <- tolima
  # i = 1
  
  values <- extract(r, shape[i, ]) %>%
    unlist()
  
  values <- data_frame(values, NOM_MUNICI = shape[i, ]@data$NOM_MUNICI)
  
  return(values)
}

# extract_by_polygon(1, r = text_dptos, shape = soils_dpto)
library(foreach)
library(doSNOW) 

cl <- makeCluster(3)
registerDoSNOW(cl)  ## For Windows

to_ <- 1:dim(soils_dpto)[1]

values <- foreach(i = to_, .packages = c('raster', 'dplyr', 'rgdal', 'foreach')) %dopar% {
  
  extract_by_polygon(i, r = text_dptos, shape = soils_dpto)
  
}

values <- values %>%
  bind_rows()

values_text <- inner_join(values, class_textura,  by = c("values" = "ClaseNum"))

stopCluster(cl) 

soils_dpto_df <- soils_dpto %>%
  as_data_frame()

soils_dpto_text <- inner_join(soils_dpto_df, values_text, by = 'NOM_MUNICI')

soils_dpto_text <- soils_dpto_text %>%
  nest(-NOM_MUNICI)


##
mode_df <- function(data, var, n_top){
  
  # data <- values_text
  # var <- 'ClaseText'
  # n_top <- 10
  
  suppressMessages(data <-  select_(data, var) %>%
                     group_by_(var) %>%
                     summarise(n = n()) %>%
                     top_n(n_top) %>%
                     arrange(desc(n)))
  
  return(data)
}

top_text <- tolima_text %>%
  mutate(mode_ = map(data, mode_df, 'ClaseText', 1)) %>%
  unnest(mode_) %>%
  dplyr::select(-data)

tolima_mod <- inner_join(tolima, top_text, by = 'NOM_MUNICI', copy = TRUE) 
  

tolima_mod_map <- tolima_mod %>%
  tidy() %>%
  inner_join(., tolima_mod, by = c('id'= 'OBJECTID'), copy = TRUE)

tolima_mod
# tolima@data[['NOM_MUNICI']] <- rownames(tolima@data)

tolima_mod  %>%
  dplyr::select(OBJECTID, NOM_MUNICI, ClaseText) %>%
  broom::tidy(region = 'OBJECTID')

  
soils_dpto %>%
  tidy(region = c('NOMBRE_DPT'))
  
  
g <- ggplot() + 
  geom_polygon(data = tolima_mod_map, aes(long, lat, group = group),
               fill="white", colour = "black", size = 0.1) + 
  coord_equal() + 
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  labs(x='Longitude', y='Latitude') +
  theme_bw()  

h <- g + 
  geom_polygon(data = tolima_mod_map, aes(long, lat, group = group, fill = ClaseText),
               colour = "black", size = 0.1,  alpha = 0.5) + 
  scale_fill_manual(values = c("#dfc27d", "#a6611a", "#80cdc1", "#018571"), name= "Textura")   

  

  
# tolima_df %>%
#   mutate(shape = tolima[1:nrow(.), ])
# 
# map(1, extract_by_polygon, r = text_tolima, shape = tolima)
# 
# extract(r, shape[1, ], sp=TRUE)
# lapply(1:45, extract_by_polygon, r = text_tolima, shape = tolima)
# 
# 
# 1:10 %>%
#   map(rnorm, n = 10)

## realizar los calculos para las zonas de estudio top 5 de las tesxturas por municipio


region <- crop(shape_colombia, extent_region) %>%
  tidy(region = 'NOM_MUNICI') %>%
  tbl_df()

soils_dpto_fortify <- soils_dpto %>%
  tidy(region = c('NOMBRE_DPT')) %>%
  tbl_df()

extent_region %>%
  filter(str_detect(NOMBRE_DPT, 'TOLIMA|CÓRDOBA|VALLE|CASANARE'))




g <- ggplot() + 
  geom_polygon(data = region, aes(long, lat, group = group),
               fill="white", colour = "black", size = 0.1) + 
  coord_equal() + 
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  labs(x='Longitude', y='Latitude') +
  theme_bw() 

h <- g + 
  geom_polygon(data = soils_dpto_fortify, aes(long, lat, group = group, fill = id),
               colour = "black", size = 0.1,  alpha = 0.5) + 
  scale_fill_manual(values = c("#dfc27d", "#a6611a", "#80cdc1", "#018571"), name= "Departamentos") 
  # geom_path(color="black")

soils_dpto_raster <- crop(raster_textura, region)
points_raster <- rasterToPoints(soils_dpto_raster) %>% 
  tbl_df()

ggplot() + 
  geom_tile(data=points_raster,aes(x, y, fill= Clasificacion_textural))+
  theme(legend.position = "none")
  

h +
  geom_tile(data=soils_dpto_raster,aes(x, y, fill= Clasificacion_textural)) +
  theme(legend.position = "none")
####




shape_soils_rasta <- inner_join(soils_dpto, soil_rasta_df, by = c('NOMBRE_DPT', 'NOM_MUNICI'))




# soil_rasta_df <- soil_rasta_df %>%
#   rename(NOMBRE_DPT = DEPARTAMENTO, 
#          NOM_MUNICI = MUNICIPIO)

## Mostrar las texturas de rasta por departamento y municipio
soil_mun <- soil_rasta_df %>%
  dplyr::select(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  group_by(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  summarise(n = n()) %>%
  ungroup()

# select top 
soil_mun %>%

ggplot(data=soil_mun, aes(x=TEXTURAS, y=n, fill = MUNICIPIO)) +
  geom_bar(stat="identity") +
  facet_wrap(~ DEPARTAMENTO)
  


## Estadísticas descriptivas por Departamento y Municipio
soil_rasta_df %>%
  dplyr::select(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  group_by(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  ungroup()


