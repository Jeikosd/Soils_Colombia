library(tidyverse)
library(raster)
library(foreign)
library(rgdal)
library(spdplyr)
library(stringr)
library(rgeos)
library(broom)
library(maptools)
library(soiltexture)


path_data <- 'data/'

## Textura informacion CIAT
raster_textura <- raster(paste0(path_data, 'Soil_Colombia/Clasificación textural/Clasificacion textural.tif'))  ## Clasificación de texturas
class_textura <- read.dbf(paste0(path_data, 'Soil_Colombia/Clasificación textural/Clasificacion textural.tif.vat.dbf'))


class_textura <- class_textura %>%
  mutate(ClaseNum = 1:length(ClaseText))

## Shape Colombia SIGOT
shape_colombia <- readOGR(dsn = paste0(path_data, 'Shape_Colombia/Municipios_SIGOT_geo.shp'),
                          layer = 'Municipios_SIGOT_geo')


## Cambiando la codificacion de las columnas necesarias

shape_colombia <- shape_colombia %>%
  mutate(NOM_MUNICI = iconv(NOM_MUNICI, 'UTF-8', 'latin1'), 
         NOMBRE_DPT = iconv(NOMBRE_DPT, 'UTF-8', 'latin1'))


## Rasta information (was generated by AEPS (Big Data CIAT))

rasta <- read_csv(paste0(path_data, 'Soil_Rasta/Rastas_3.csv'),cols(
  .default = col_character(),
  ID_LOTE = col_integer(),
  ID_FINCA = col_integer(),
  ID_RASTA = col_integer(),
  PENDIENTE = col_double(),
  NO_CAPAS = col_integer(),
  ESPESORES = col_character(),
  PH = col_double(),
  PROFUNDIDAD_CARBONATOS = col_integer(),
  HOR_PEDREG_ROCOSO_PROFUNDIDAD_RASTA = col_integer(),
  HOR_PEDREG_ROCOSO_ESPESOR_RASTA = col_integer(),
  PROFUND_PRIMERAS_ROCAS_PIEDRAS_RASTA = col_integer(),
  PROFUND_CAP_ENDURE_RASTA = col_integer(),
  ESPESOR_CAP_ENDURE_RASTA = col_double(),
  PROFUND_MOTEADOS_RASTA = col_integer(),
  PROFUND_RAICES_VIVAS_RASTA = col_integer()
  ), col_names = T) %>%
  mutate(ID_LOTE = as.character(ID_LOTE))

# rasta <- read.csv(paste0(path_data, 'Soil_Rasta/Rastas_3.csv')) %>%
#   tbl_df() %>%
#   mutate(ID_LOTE = as.character(ID_LOTE))

# filter(rasta, ESPESORES == 0.5)

## Management Cordoba

management_cordoba <- read_csv(paste0(path_data, 'Soil_Rasta/Practicas_Cordoba.csv'))
# read.csv(paste0(path_data, 'Soil_Rasta/Practicas_Cordoba.csv'))

identifier <- read_csv(paste0(path_data, 'Soil_Rasta/identificadores.csv'))

## sacar textura para Cordoba (merge entre rasta y el archivo de Practicas cordoba by ID_LOTE)

vars_ID <- management_cordoba %>%
  dplyr::select(ID_LOTE, MUNICIPIO, DEPARTAMENTO, TIPO_CULTIVO, LAT_LOTE, LONG_LOTE) %>%
  filter(!is.na(LONG_LOTE), !is.na(LAT_LOTE)) %>%
  mutate(lat = classify_coords(LAT_LOTE, long = F), long = classify_coords(LONG_LOTE))

# filter(vars_ID, is.na(long))
# filter(vars_ID, is.na(lat))

##


soil_rasta_df <- inner_join(rasta, vars_ID, by = 'ID_LOTE')



## Departamentos a utilizar: Tolima, Cordoba, Valle, Casanare
# es importante poder mostrar en que lados de Colombia tenemos informacion acerca de la informacion de Rasta

zonas <- paste('TOLIMA', 'CÓRDOBA', 'VALLE', 'CASANARE', sep = '|')

soils_dpto <- shape_colombia %>%
  filter(str_detect(NOMBRE_DPT, zonas))

# soils_dpto %>%
#   dplyr::select(NOMBRE_DPT) %>%
#   group_by(NOMBRE_DPT) %>%
#   summarise(n())
# tidy(soils_dpto, region = "NOMBRE_DPT")

extent_region <- soils_dpto %>%
  extent()


text_dptos <- crop(raster_textura, extent_region)  ## textura Mayesi para la zona de estudio

# plot(text_dptos)
# plot(soils_dpto, add = T)

## plotear las 5 texturas mas representativas por departamento y por muninicipio
# tolima <- filter(soils_dpto, NOMBRE_DPT == 'TOLIMA')
# text_tolima <- crop(text_dptos, tolima)

# tolima_df <- filter(soils_dpto, NOMBRE_DPT == 'TOLIMA') %>%
#   .@data %>%
#   tbl_df()

# extract(text_tolima, tolima)  funciona

extract_by_polygon <- function(i, r, shape){
  
  # r <- text_tolima
  # shape <- tolima
  # i = 1
  
  values <- extract(r, shape[i, ]) %>%
    unlist()
  
  values <- data_frame(values, NOM_MUNICI = shape[i, ]@data$NOM_MUNICI)
  
  return(values)
}

# extract_by_polygon(1, r = text_dptos, shape = soils_dpto)
library(foreach)
library(doSNOW) 

cl <- makeCluster(25)
registerDoSNOW(cl)  ## For Windows

to_ <- 1:dim(soils_dpto)[1]

values <- foreach(i = to_, .packages = c('raster', 'dplyr', 'rgdal', 'foreach')) %dopar% {
  
  extract_by_polygon(i, r = text_dptos, shape = soils_dpto)
  
}

values <- values %>%
  bind_rows()

values_text <- inner_join(values, class_textura,  by = c("values" = "ClaseNum"))

stopCluster(cl) 

soils_dpto_df <- soils_dpto %>%
  as_data_frame()

soils_dpto_text <- inner_join(soils_dpto_df, values_text, by = 'NOM_MUNICI')

soils_dpto_text <- soils_dpto_text %>%
  nest(-NOM_MUNICI, -NOMBRE_DPT)





mode_df <- function(data, var, n_top){
  
  # data <- values_text
  # var <- 'ClaseText'
  # n_top <- 10
  
  suppressMessages(data <-  select_(data, var) %>%
                     group_by_(var) %>%
                     summarise(n = n()) %>%
                     top_n(n_top) %>%
                     arrange(desc(n))
                   
  )
  
  return(data)
}


top_text <- soils_dpto_text %>%
  mutate(mode_ = map(data, mode_df, 'ClaseText', 1)) %>%
  unnest(mode_) %>%
  dplyr::select(-data)

soils_dpto_Sptext <- inner_join(soils_dpto, top_text, by = 'NOM_MUNICI', copy = TRUE) %>%
  dplyr::select(-nombre) %>%
  as_data_frame()

  
# soils_dpto_mod <- soils_dpto
# soils_dpto_mod@data <- soils_dpto_Sptext

soils_dpto_tidy <- soils_dpto %>%
  tidy(region = 'NOM_MUNICI') %>%
  inner_join(., soils_dpto_Sptext, by = c('id'= 'NOM_MUNICI')) %>%
  tbl_df()



# soils_dpto_tidy
  
  
# g <- ggplot() + 
#   geom_polygon(data = soils_dpto_tidy, aes(long, lat, group = group),
#                fill="white", colour = "black", size = 0.1) + 
#   coord_equal() + 
#   scale_x_continuous(expand=c(0,0)) + 
#   scale_y_continuous(expand=c(0,0)) +
#   labs(x='Longitude', y='Latitude') +
#   theme_bw()  
# 
# h <- g + 
#   geom_polygon(data = soils_dpto_tidy, aes(long, lat, group = group, fill = ClaseText),
#                colour = "black", size = 0.1,  alpha = 0.5) + 
#   scale_fill_manual(values = c("#8c510a", "#bf812d", "#c7eae5", "#80cdc1", "#35978f", "#01665e" , "#003c30"), name= "Textura")   
# 
#   

  
# tolima_df %>%
#   mutate(shape = tolima[1:nrow(.), ])
# 
# map(1, extract_by_polygon, r = text_tolima, shape = tolima)
# 
# extract(r, shape[1, ], sp=TRUE)
# lapply(1:45, extract_by_polygon, r = text_tolima, shape = tolima)
# 
# 
# 1:10 %>%
#   map(rnorm, n = 10)

## realizar los calculos para las zonas de estudio top 5 de las tesxturas por municipio


region <- crop(shape_colombia, extent_region) %>%
  tidy(region = 'NOM_MUNICI') %>%
  tbl_df()


g <- ggplot() + 
  geom_polygon(data = region, aes(long, lat, group = group),
               fill="white", colour = "gray", size = 0.1,  alpha = 0.5) + 
  coord_equal() + 
  scale_x_continuous(expand=c(0,0)) + 
  scale_y_continuous(expand=c(0,0)) +
  labs(x='Longitude', y='Latitude') +
  theme_bw() 

h <- g + 
  geom_polygon(data = soils_dpto_tidy, aes(long, lat, group = group, fill = ClaseText),
               colour = "black", size = 0.1,  alpha = 0.5) + 
  scale_fill_manual(values = c("#8c510a",
                               "#bf812d",
                               "#c7eae5",
                               "#80cdc1",
                               "#35978f",
                               "#01665e",
                               "#003c30"), name= "Textura") +
  ggtitle("Clases Texturales Mayesi")



# shape_soils_rasta <- inner_join(soils_dpto, soil_rasta_df, by = c('NOMBRE_DPT', 'NOM_MUNICI'))

# dplyr::select(soils_dpto, NOM_MUNICI, NOMBRE_DPT) 
# dplyr::select(soil_rasta_df, MUNICIPIO, DEPARTAMENTO)

filter(soils_dpto, str_detect(NOMBRE_DPT, 'VALLE'))
filter(soil_rasta_df, str_detect(DEPARTAMENTO, zonas)) %>%
  dplyr::select(DEPARTAMENTO) %>%
  magrittr::extract2(1) %>%
  unique()

# soil_rasta_df <- soil_rasta_df %>%
#   rename(NOMBRE_DPT = DEPARTAMENTO, 
#          NOM_MUNICI = MUNICIPIO)






## Mostrar las texturas de rasta por lat y long
soil_rasta_vars <- soil_rasta_df %>%
  filter(TIPO_CULTIVO == 'Maiz') %>%
  dplyr::select(NO_CAPAS, PH, TEXTURAS, DEPARTAMENTO, MUNICIPIO, TIPO_CULTIVO, LAT_LOTE, LONG_LOTE, lat, long) %>%
  mutate(ID = 1:length(NO_CAPAS))
 
## arreglar un individuo por textura (plotear la textura de la primera profundidad)

tidy_rasta_soil <- soil_rasta_vars %>%
  mutate(TEXTURAS = strsplit(TEXTURAS, ",")) %>%
  unnest(TEXTURAS) %>% ## seleccionamos la textura de la primera profundidad
  group_by(ID) %>%
  filter(row_number() == 1) %>%
  ungroup()


tidy_rasta_soil <- inner_join(tidy_rasta_soil, identifier, by = c('TEXTURAS' = 'Spanish_key'))
text_dptos

### buffer puntos
## illustrating the varying size of a buffer (expressed in meters) 
## on a longitude/latitude raster
raster::extract(text_dptos, dplyr::select(tidy_rasta_soil, long, lat), buffer= 4000)

coordinates(tidy_rasta_soil) <- c( "long", "lat")
sr <- '+proj=tmerc +lat_0=4.596200416666666 +lon_0=-74.07750791666666 +k=1 +x_0=1000000 +y_0=1000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
proj4string(tidy_rasta_soil) <- CRS(sr)
pc <- spTransform(tidy_rasta_soil, CRS(sr)) 
distInMeters <- 3000
dplyr::row_number(pc, 1)
pc100km <- gBuffer( pc[1, ], width=distInMeters, byid=TRUE )

Landcover <- extract(NLCD, sites_transformed, buffer=buffer)
## calculos por departamento y municipio

rasta_textura <- tidy_rasta_soil %>%
  group_by(MUNICIPIO) %>%
  nest() %>%
  mutate(mode_ = map(data, mode_df, 'name', 1)) %>%
  unnest(mode_)

# rasta_textura_sp <- inner_join(soils_dpto, rasta_textura, by = c('NOM_MUNICI' = 'MUNICIPIO'))

rasta_textura_tidy <- soils_dpto %>%
  tidy(region = 'NOM_MUNICI') %>%
  inner_join(., rasta_textura, by = c('id' = 'MUNICIPIO')) %>%
  tbl_df()



centroids.df <- as_data_frame(coordinates(rasta_textura_sp)) %>%
  rename(long = V1, lat = V2)
centroids.df <- data.frame(centroids.df, data.frame(rasta_textura_sp)) %>%
  as_data_frame()

library(ggrepel)

r <- h + 
  geom_label_repel(data = centroids.df,
                   aes(label = name, x = long, y = lat),
                   fontface = 'bold',
                   box.padding = unit(0.35, "lines"),
                   point.padding = unit(0.5, "lines"),
                   segment.color = 'black'
                   
  ) +
  ggtitle("Clases Texturales Mayesi vs Rasta")

## luego continuar con la comparacion para JR ##
### graficos necesarios para los muchachos ####

## calcular top 3 texturas dpto mun

# soils_dpto_Sptext %>%
  # dplyr::select(NOMBRE_DPT, NOM_MUNICI, ClaseText)
  


top_text <- soils_dpto_text %>%
  mutate(mode_ = map(data, mode_df, 'ClaseText', 3)) %>%
  unnest(mode_)

# filtrar para los municipios de estudio

mun_usaid <- c('YOPAL', 'LORICA', 'IBAGUÉ', 'LA UNIÓN', 'ESPINAL', 'CERETÉ')
mun_usaid <- paste(mun_usaid, collapse = '|')
mun_usaid_text <- filter(top_text, str_detect( NOM_MUNICI, mun_usaid))

# filter(soils_dpto_text, str_detect(NOMBRE_DPT, 'VALLE')) %>%
#   dplyr::select(NOM_MUNICI) %>%
#   magrittr::extract2(1)

library(forcats)
mun_usaid_text <- mun_usaid_text %>%
  mutate(top_textura = fct_reorder(factor(n), n, .desc = FALSE), 
         NOM_MUNICI = fct_reorder(NOM_MUNICI, n, .desc = FALSE))

ggplot(mun_usaid_text, aes(NOM_MUNICI, top_textura, fill = ClaseText)) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = c("#8c510a",
                               "#bf812d",
                               "#c7eae5",
                               "#80cdc1",
                               "#35978f",
                               "#01665e",
                               "#003c30"), name= "Textura") +
  geom_text(aes(NOM_MUNICI, top_textura, label = ClaseText), 
            position = position_dodge(0.99),
            vjust= - 1)


## Los muchachos Necesitan PH (boxplot y añadir los top 3 como puntos)

rasta_ph <- tidy_rasta_soil %>%
  filter(str_detect(MUNICIPIO, mun_usaid)) 
  
rasta_ph <- rasta_ph %>%
  mutate(MUNICIPIO = fct_reorder(MUNICIPIO, PH, .desc = FALSE))

ggplot(rasta_ph , aes(MUNICIPIO, PH)) +
  geom_boxplot() +
  ggtitle("PH Municipios") +
  labs(ylab('PH'))


## Anadir coincidencia HGEN suelos DSSAT

library(data.table)
## a~nadir leer encabezado
header <- scan(paste0(path_data, 'Soil_HC/HC.SOL'), what = "character", skip = 5, nlines = 1, quiet = T)
header <- header[!str_detect('@', header)]
proof <- read_lines(paste0(path_data, 'Soil_HC/HC.SOL'))

# grep("SLB", proof)
# str_which(proof, "SLB")

str_subset(proof, 'HC_GEN') %>%
  sub(" .*$", "", .)


str_detect(proof, coll('HC_GEN'))
str_count("one,   two three 4,,,, 5 6", "\\S+")

## match SLB (@  SLB)
HC_soil <- fread(paste0(path_data, 'Soil_HC/HC.SOL'), skip = 6, header = F, fill = TRUE, nrows = 6) %>%
  tbl_df()

  
HC_soil %>%
  purrr::discard(is_logical)

HC_soil %>%
  select_if(is_logical)


colnames(HC_soil) <- header

# ggplot(mun_usaid_text, aes(NOM_MUNICI, factor(n), fill = ClaseText)) +
#   geom_bar(stat="identity", position=position_dodge()) +
#   scale_fill_manual(values = c("#8c510a",
#                                "#bf812d",
#                                "#c7eae5",
#                                "#80cdc1",
#                                "#35978f",
#                                "#01665e",
#                                "#003c30"), name= "Textura") +
#   geom_text(aes(NOM_MUNICI, factor(n), label = ClaseText),
#             position = position_dodge(0.99),
#             vjust= - 1)






nest_rasta_soil <- tidy_rasta_soil %>%
  group_by(ID) %>%
  mutate(row = paste0('depth_', row_number())) %>%
  nest()

## prueba
rasta_textura <- mutate(nest_rasta_soil, mode_textura = map(data, mode_df, 'name', 1), no_depth = map(data, length('name'))) %>%
  unnest(mode_textura, .drop = FALSE) %>%
  unnest(no_depth)
  group_by(ID) %>%
  filter(row_number()==1) %>%
  ungroup()

unnest(rasta_textura, data)

## solo un individuo por ID? será mejor?
tidy_rasta_soil %>%
  group_by(ID) %>%
  mutate(row = paste0('depth_', row_number())) %>%
  spread(row, TEXTURAS) %>%
  ungroup()


# sacar el top

rasta_top <- soil_rasta_mun %>%
  group_by(MUNICIPIO) %>%
  top_n(1) %>%
  ungroup()

soil_rasta_df %>%
  mutate(TEXTURAS = strsplit(TEXTURAS, ",")) %>%
  unnest(TEXTURAS) %>%
  dplyr::select(TEXTURAS) %>%
  magrittr::extract2(1) %>%
  unique()


proof %>%
  mutate(TEXTURAS = strsplit(TEXTURAS, ",")) %>%
  unnest(TEXTURAS) %>%
  group_by(MUNICIPIO) %>%
  mutate(row = row_number()) %>%
  spread(row, TEXTURAS)
  
# dat %>% mutate(to = strsplit(to, ",")) %>%
#   unnest(to) %>%
#   group_by(MUNICIPIO) %>%
#   mutate(row = row_number()) %>%
#   spread(row, to)

separate(proof, TEXTURAS, into, sep = " ", remove = TRUE, convert = FALSE)

soil_rasta_mun %>%
  group_by(MUNICIPIO) %>%
  top_n(1) %>%
  magrittr::extract2(1) %>%
  unique()

filter(soil_rasta_mun, MUNICIPIO == 'LA PLATA')

soil_rasta_mun %>%
  spread(TEXTURAS, PH)

# pegar rasta en el shapefile

# select top 
soil_mun %>%

ggplot(data=soil_mun, aes(x=TEXTURAS, y=n, fill = MUNICIPIO)) +
  geom_bar(stat="identity") +
  facet_wrap(~ DEPARTAMENTO)
  


## Estadísticas descriptivas por Departamento y Municipio
soil_rasta_df %>%
  dplyr::select(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  group_by(TEXTURAS, DEPARTAMENTO, MUNICIPIO) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  ungroup()


